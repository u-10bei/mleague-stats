# Mリーグダッシュボード 🀄

Mリーグの対戦結果を可視化するStreamlitダッシュボードです。

## 機能

### 閲覧機能
- **トップページ**: Mリーグの概要とチーム一覧、最新シーズンのハイライト
- **年度別ランキング**: 各シーズンのチーム別成績と順位推移グラフ
- **累積ランキング**: 全シーズン通算の成績と累積ポイント推移グラフ

### 管理機能（開発環境用）
- **データ管理**: チーム情報・シーズンポイントの入力・編集・削除
- **選手管理**: 選手情報・所属履歴・シーズン成績の入力・編集・削除
- **シーズン更新**: 新シーズン開始時のチーム名変更と選手移籍を一括処理
- **選手成績入力**: シーズンごとの選手成績を一覧表示して一括入力（データ整合性チェック付き）

## セットアップ

### ローカル環境

```bash
# リポジトリをクローン
git clone https://github.com/your-username/mleague-dashboard.git
cd mleague-dashboard

# 依存関係をインストール
pip install -r requirements.txt

# データベース初期化（初回のみ）
python init_db.py

# Mリーグの実データを投入（初回のみ）
python populate_data.py

# アプリを起動
streamlit run app.py
```

### GitHub Codespaces

1. GitHubリポジトリで「Code」→「Codespaces」→「Create codespace on main」
2. 自動的に環境がセットアップされます
3. ターミナルで以下を実行:
   ```bash
   pip install -r requirements.txt
   python init_db.py
   python populate_data.py
   streamlit run app.py
   ```

## プロジェクト構成

```
mleague-dashboard/
├── .devcontainer/
│   └── devcontainer.json          # Codespaces設定
├── data/
│   └── mleague.db                 # SQLiteデータベース
├── pages/
│   ├── 1_season_ranking.py        # 年度別ランキング
│   ├── 2_cumulative_ranking.py    # 累積ランキング
│   ├── 3_admin.py                 # データ管理（チーム・ポイント）
│   ├── 4_player_admin.py          # 選手管理
│   ├── 5_season_update.py         # シーズン更新処理
│   └── 6_player_stats_input.py    # 選手成績入力
├── app.py                         # メインアプリ（トップページ）
├── db.py                          # データベース接続ユーティリティ
├── init_db.py                     # データベース初期化スクリプト
├── populate_data.py               # 実データ投入スクリプト
├── migrate_add_players.py         # 選手テーブル追加マイグレーション
├── requirements.txt
└── README.md
```

## データについて

`populate_data.py`を実行すると、以下のMリーグ実データが投入されます：

### チーム情報（10チーム）
- 赤坂ドリブンズ
- EX風林火山
- KADOKAWAサクラナイツ
- KONAMI麻雀格闘倶楽部
- 渋谷ABEMAS
- セガサミーフェニックス
- TEAM RAIDEN / 雷電
- BEAST X（2023年参入）
- U-NEXT Pirates（2019年参入）
- EARTH JETS（2025年新設）

### 選手情報（40名）
2024-25シーズンの現役Mリーガー全40名
- 選手名、生年月日、所属プロ団体を含む

### シーズン成績
2018シーズン～2024シーズン（7シーズン分）の最終順位とポイント

**データソース**: Mリーグ公式サイト、Wikipedia、ABEMAの公開情報を元に作成

## データベース

データはSQLiteデータベース (`data/mleague.db`) に保存されています。

### 初期化

```bash
# 新規作成（既存データは削除されます）
python init_db.py
```

### マイグレーション

```bash
# 既存データを保持したまま選手テーブルを追加
python migrate_add_players.py
```

### テーブル構造

#### チーム関連
| テーブル | 説明 |
|---------|------|
| `teams` | チームマスター（team_id, short_name, color, established） |
| `team_names` | チーム名履歴（team_id, season, team_name）※年度別のチーム名変更に対応 |
| `team_season_points` | シーズン別ポイント（season, team_id, points, rank） |

#### 選手関連
| テーブル | 説明 |
|---------|------|
| `players` | 選手マスター（player_id, player_name, birth_date, pro_org） |
| `player_teams` | 選手所属履歴（player_id, team_id, season） |
| `player_season_stats` | 選手シーズン成績（player_id, season, games, points, rank_1st〜4th） |

## 管理画面の使い方

### データ管理（⚙️）

| タブ | 機能 |
|-----|------|
| 📝 シーズンポイント入力 | チームのシーズンポイントを個別または一括で入力 |
| 🏢 チーム管理 | チームの追加・編集・削除 |
| 📋 データ確認 | 登録データの確認・削除 |

**注**: チーム名の変更は「🔄 シーズン更新」ページで一括処理できます。

### 選手管理（👤）

| タブ | 機能 |
|-----|------|
| 📝 選手登録 | 新規選手の登録（初期所属チーム設定） |
| ✏️ 選手編集 | 選手情報の編集、移籍入力（OUT/IN形式）、削除 |
| 📋 選手一覧 | 登録選手の一覧表示 |

**注**: 選手の成績入力は「📊 選手成績入力」ページで一括入力できます。

### シーズン更新（🔄）

新シーズン開始時の更新作業を一括で行います。

| タブ | 機能 |
|-----|------|
| 🏷️ チーム名設定 | 新シーズンのチーム名を確認・編集 |
| 👥 選手移籍入力 | 全選手の残留・移籍・退団を一括入力 |
| ✅ 確認と登録 | 変更内容を確認してデータベースに登録 |

**使い方**
1. 新シーズン番号を入力（例: 2025）
2. チーム名設定タブで各チームの名称を確認・編集して保存
3. 選手移籍入力タブで全選手の状態（残留/移籍/退団）を選択して保存
4. 確認と登録タブで内容を確認して「データベースに登録」

**注意事項**
- 前シーズンのデータが存在している必要があります
- 一度登録すると元に戻せません
- 新加入選手（ドラフト指名選手）は別途「選手管理」で登録してください

---

**個別移籍の入力（選手編集タブ）**

シーズン途中の移籍や過去データの修正に使用します。

1. 選手編集タブで編集する選手を選択
2. 「移籍入力」セクションで移籍先シーズンを入力
3. OUT（離脱元チーム）が自動表示されます
4. IN（加入先チーム）を選択して「移籍を登録」
5. 所属履歴に「OUT: チーム名 → IN: チーム名」形式で表示されます

**使い分け:**
- **シーズン更新**: 新シーズン開始時の全選手の移籍を一括処理
- **個別移籍**: 過去データの修正や追加登録

### 選手成績入力（📊）

シーズンごとの選手成績を一覧表示して一括入力できます。

**機能**
- シーズン選択
- チームごとに選手を一覧表示
- 各選手の成績を入力（試合数、ポイント、1位〜4位回数）
- 一括保存
- データ整合性チェック
  - **選手個別**: 順位回数の合計が試合数と一致するか
  - **チームスコア**: チーム全体のスコアと選手スコア合計が一致するか ✨ **NEW!**
- 統計情報表示（総選手数、成績入力済み数、総試合数、総ポイント）

**データ整合性チェックの詳細**

1. **選手個別チェック**
   - 1位〜4位の回数の合計が試合数と一致するかチェック
   - 不整合がある場合は警告表示

2. **チームスコアチェック** ✨ **NEW!**
   - チーム全体のスコア（team_season_pointsテーブル）と、そのチームに所属する選手のスコア合計が一致するかチェック
   - 小数点誤差（0.1pt以内）は許容範囲とみなす
   - 不整合がある場合は、チーム名と差分を表示

**使い方**
1. 成績を入力するシーズンを選択
2. チームごとに展開された選手一覧で成績を入力
3. 「一括保存」ボタンで全選手の成績を保存
4. データ確認セクションで整合性をチェック
   - 選手個別チェック: 順位回数の合計が試合数と一致するか
   - チームスコアチェック: チームスコアと選手スコア合計が一致するか

**注意事項**
- 既存データがある場合は自動的に表示されます
- 整合性チェックは警告のみで、保存は可能です
- チームスコアチェックを行うには、先に「データ管理」ページでチームスコアを登録してください
- 保存前に確認画面でデータをチェックできます

---

**所属プロ団体の履歴表記**
- 所属プロ団体フィールドで移籍履歴を記録できます
- 例: `日本プロ麻雀協会→最高位戦日本プロ麻雀協会(2020-)` のように記入
- 複数行入力に対応しています

**生年月日の扱い**
- 生年月日が公表されていない選手は空欄でOKです
- 空欄の場合、一覧表示では「-」と表示されます
- `migrate_birth_date_nullable.py` でNULL許可に変更済み

## デプロイ

### Streamlit Community Cloud

1. GitHubにリポジトリをプッシュ
2. [share.streamlit.io](https://share.streamlit.io) にアクセス
3. 「New app」からリポジトリを選択
4. メインファイルに `app.py` を指定
5. 「Deploy」をクリック

## 今後の拡張予定

- [x] シーズン更新処理（チーム名変更・選手移籍の一括処理）✨ **完成！**
- [x] 選手成績入力（一覧表示・一括入力）✨ **完成！**
- [x] データ整合性チェック（チームスコア）✨ **完成！**
- [ ] 選手別成績ページ（閲覧用）
- [ ] 対戦詳細データ
- [ ] 和了率・放銃率などの詳細指標
- [ ] データのインポート/エクスポート機能

## ライセンス

MIT License
