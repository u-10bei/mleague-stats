# mleague-stats 🀄

Mリーグの対戦結果を可視化するStreamlitダッシュボードです。

## 機能

### 閲覧機能

**チーム成績**
- **トップページ**: Mリーグの概要とチーム一覧、最新シーズンのハイライト
- **年度別チームランキング**: 各シーズンのチーム別成績と順位推移グラフ
- **累積チームランキング**: 全シーズン通算のチーム成績と累積ポイント推移グラフ
- **チーム半荘別分析**: 半荘記録からチーム成績を分析（席順別・試合番号別・直対ランキング）

**選手成績**
- **年度別選手ランキング**: 各シーズンの選手別成績とランキング、順位推移グラフ
- **累積選手ランキング**: 全シーズン通算の選手成績と累積ポイント推移グラフ、選手別詳細履歴
- **選手半荘別分析**: 半荘記録から全選手の成績をランキング表で表示（月別・席順別・試合番号別）

**詳細分析**
- **統計分析**: 選手の席別パフォーマンス、ポジション分析
- **連続記録**: 連勝・連敗・連続連対・連続逆連対の記録分析
- **対局記録**: 対局の時間記録（最長・最短・平均試合時間）

### 管理機能

**データ入力・編集**
- **データ管理**: チームのシーズンポイント入力・編集・削除、ペナルティ入力、データ整合性チェック
- **選手管理**: 選手情報の登録・編集・削除、チーム所属の管理、生年月日・所属団体の管理
- **チーム管理**: チームマスター情報の登録・編集・削除、チーム略称・カラー・設立年の管理
- **選手成績入力**: シーズンごとの選手成績を一括入力（試合数、ポイント、ペナルティ、順位回数）
- **半荘記録入力**: 半荘ごとの詳細な対局結果を記録（日付、時間、卓区分、席、選手、ポイント、順位）、既存データの編集・削除

**一括処理**
- **シーズン更新**: 新シーズン開始時のチーム名変更と選手移籍を一括処理

## セットアップ

### ローカル環境

```bash
# リポジトリをクローン
git clone https://github.com/your-username/mleague-stats.git
cd mleague-stats

# 依存関係をインストール
pip install -r requirements.txt

# データベース初期化（初回のみ）
python init_db.py

# アプリを起動
streamlit run app.py
```

### GitHub Codespaces

1. GitHubリポジトリで「Code」→「Codespaces」→「Create codespace on main」
2. 自動的に環境がセットアップされます
3. ターミナルで以下を実行:
   ```bash
   pip install -r requirements.txt
   python init_db.py
   streamlit run app.py
   ```

## プロジェクト構成

```
mleague-stats/
├── .devcontainer/
│   └── devcontainer.json          # Codespaces設定
├── data/
│   └── mleague.db                 # SQLiteデータベース
├── pages/
│   ├── 1_season_ranking.py        # 年度別チームランキング
│   ├── 2_cumulative_ranking.py    # 累積チームランキング
│   ├── 3_admin.py                 # データ管理（チーム・ポイント）
│   ├── 4_player_admin.py          # 選手管理
│   ├── 5_season_update.py         # シーズン更新処理
│   ├── 6_player_stats_input.py    # 選手成績入力
│   ├── 7_player_season_ranking.py # 年度別選手ランキング
│   ├── 8_player_cumulative_ranking.py # 累積選手ランキング
│   ├── 9_team_master_admin.py     # チーム管理
│   ├── 10_team_game_analysis.py   # チーム半荘別分析（席順別・試合番号別・直対）
│   ├── 11_game_results_input.py   # 半荘記録入力
│   ├── 13_player_game_analysis.py # 選手半荘別分析（月別・席順別・試合番号別）
│   ├── 14_statistical_analysis.py # 統計分析（席別パフォーマンス）
│   ├── 15_game_records.py         # 対局記録（試合時間）
│   └── 16_streak_records.py       # 連続記録（連勝・連敗・連対）
├── app.py                         # メインアプリ（トップページ）
├── db.py                          # データベース接続ユーティリティ
├── init_db.py                     # データベース初期化スクリプト
├── requirements.txt
└── README.md
```

## データについて

### 初期データ

`init_db.py`を実行すると、以下のMリーグ基本データが投入されます：

#### チームマスター情報（10チーム）
- 赤坂ドリブンズ（2018年～）
- EX風林火山（2018年～）
- KONAMI麻雀格闘倶楽部（2018年～）
- 渋谷ABEMAS（2018年～）
- セガサミーフェニックス（2018年～）
- TEAM RAIDEN / 雷電（2018年～）
- U-NEXT Pirates（2018年～）
- KADOKAWAサクラナイツ（2019年参入）
- BEAST X（2023年参入）
- EARTH JETS（2025年新設）

#### 2018シーズンのチーム名（7チーム）
Mリーグ開幕年である2018シーズンの7チームが登録されます。

### データ入力方法

アプリ内の管理ページから実データを入力できます：

1. **データ管理ページ**: シーズンポイントの入力・更新、ペナルティ入力
2. **選手管理ページ**: 選手の登録・編集、生年月日・所属団体の管理
3. **チーム管理ページ**: チームマスター情報の登録・編集
4. **シーズン更新ページ**: 新しいシーズンの追加とチーム名の設定
5. **選手成績入力ページ**: 選手の年度別成績の入力、ペナルティ入力
6. **半荘記録入力ページ**: 半荘ごとの詳細な対局結果の記録

### サンプルデータの投入

サンプルデータを含めて初期化したい場合：

```bash
python init_db.py --with-sample
```

これにより、2018シーズンのサンプルデータ（チームポイント、選手8名、選手成績）が投入されます。

**データソース**: Mリーグ公式サイト、Wikipedia、ABEMAの公開情報を元に作成

## データベース

データはSQLiteデータベース (`data/mleague.db`) に保存されています。

### 初期化

```bash
# 新規作成（既存データは削除されます）
python init_db.py
```

### テーブル構造

#### チーム関連
| テーブル | 説明 |
|---------|------|
| `teams` | チームマスター（team_id, short_name, color, established） |
| `team_names` | チーム名履歴（team_id, season, team_name）※年度別のチーム名変更に対応 |
| `team_season_points` | シーズン別ポイント（season, team_id, points, penalty, rank） |

#### 選手関連
| テーブル | 説明 |
|---------|------|
| `players` | 選手マスター（player_id, player_name, birth_date, pro_org） |
| `player_teams` | 選手所属履歴（player_id, team_id, season） |
| `player_season_stats` | 選手シーズン成績（player_id, season, games, points, penalty, rank_1st〜4th） |

#### 対局記録
| テーブル | 説明 |
|---------|------|
| `game_results` | 半荘記録（season, game_date, table_type, game_number, seat_name, player_id, points, rank） |

## 画面の使い方

### 閲覧画面

#### チーム成績

**年度別チームランキング（📊）**
- シーズンを選択して、そのシーズンのチーム成績を表示
- 横棒グラフと順位表で可視化
- 全シーズンの順位推移グラフ

**累積チームランキング（🏆）**
- 全シーズン通算のチーム成績を表示
- 累積ポイント、参加シーズン数、平均ポイント
- 累積ポイント推移グラフ
- チーム別の詳細履歴

**チーム半荘別分析（📈）**
- 半荘記録からチーム成績を分析
- 席順別ランキング（東・南・西・北家での成績）
- 試合番号別ランキング（第1〜4試合での成績）
- 直対ランキング（チーム間の対戦成績）
- 全期間またはシーズン別で集計可能

#### 選手成績

**年度別選手ランキング（📊）**
- シーズンを選択して、そのシーズンの選手成績を表示
- 上位20名の横棒グラフと上位10名のランキング表
- 全選手の詳細ランキング（試合数、ポイント、順位回数、平均順位）
- 選手名検索、最低試合数フィルター
- 全シーズン順位推移グラフ（現シーズン上位10名）

**累積選手ランキング（🏆）**
- 全シーズン通算の選手成績を表示
- 上位20名の累積ポイント棒グラフ
- 累積ポイント推移グラフ（上位10名）
- 全選手の詳細ランキング（試合数、累積ポイント、順位回数、参加シーズン数、平均順位）
- 選手名検索、最低参加シーズン数・試合数フィルター
- 選手別のシーズン成績履歴

**選手半荘別分析（📈）**
- 半荘記録から全選手の成績をランキング表で表示
- 月別ランキング（累積ポイント・平均順位）
- 席順別ランキング（東・南・西・北家での成績）
- 試合番号別ランキング（第1〜4試合での成績）
- 全期間またはシーズンを選択可能

#### 詳細分析

**統計分析（📈）**
- 選手の席別パフォーマンス分析
- 各席（東・南・西・北）での成績を可視化
- トップ率・平均順位・平均ポイントを比較
- レーダーチャートで得意席を一目で把握

**連続記録（🔥）**
- 選手の連続記録を分析
- **連勝**: 連続1位
- **連敗**: 連続4位
- **連続連対**: 連続2位以内
- **連続逆連対**: 連続3位以下

**表示内容**
- 現在進行中の連続記録（TOP10）
  - 順位、選手名、連続数、開始日
- 歴代最長記録（TOP10）
  - 順位、選手名、連続数、開始日、終了日
  - 進行中の記録には✅マークを表示

**フィルター**
- 全期間またはシーズン別で集計
- 選択した期間内での連続記録を計算

**特徴**
- 現在の調子（連勝中・連敗中）が一目でわかる
- 歴代記録との比較が可能
- 期間を絞って分析できる

**対局記録（📜）**
- 対局の時間記録を分析
- 最長・最短・平均試合時間
- シーズン別・月別の傾向
- 時間帯別の分布

### 管理画面

#### データ管理（⚙️）

シーズン別のチームポイントを管理します。

**機能**
- シーズン選択とチームポイント入力
- 既存データの自動読み込み
- データ整合性チェック（合計ポイント検証）
- 一括保存・削除

**注**: チーム名の変更は「🔄 シーズン更新」ページで一括処理できます。

#### 選手管理（👤）

| タブ | 機能 |
|-----|------|
| 📋 選手一覧 | 登録選手の一覧表示、チームフィルター |
| ➕ 新規登録 | 新規選手の登録（初期所属チーム設定） |
| ✏️ 編集・削除 | 選手情報の編集、チーム所属の変更、削除 |

**注**: 選手の成績入力は「📊 選手成績入力」ページで一括入力できます。

#### シーズン更新（🔄）

新シーズン開始時の更新作業を一括で行います。

| タブ | 機能 |
|-----|------|
| 🏷️ チーム名設定 | 新シーズンのチーム名を確認・編集 |
| 👥 選手移籍入力 | 全選手の残留・移籍・退団を一括入力 |
| ✅ 確認と登録 | 変更内容を確認してデータベースに登録 |

**使い方**
1. 新シーズン番号を入力（例: 2025）
2. チーム名設定タブで各チームの名称を確認・編集して保存
3. 選手移籍入力タブで全選手の状態（残留/移籍/退団）を選択して保存
4. 確認と登録タブで内容を確認して「データベースに登録」

**注意事項**
- 前シーズンのデータが存在している必要があります
- 一度登録すると元に戻せません
- 新加入選手（ドラフト指名選手）は別途「選手管理」で登録してください

#### 選手成績入力（📊）

シーズンごとの選手成績を一覧表示して一括入力できます。

**機能**
- シーズン選択
- チームごとに選手を一覧表示
- 各選手の成績を入力（試合数、ポイント、1位〜4位回数）
- 一括保存
- データ整合性チェック
  - **選手個別**: 順位回数の合計が試合数と一致するか
  - **チームスコア**: チーム全体のスコアと選手スコア合計が一致するか
- 統計情報表示（総選手数、成績入力済み数、総試合数、総ポイント）

**使い方**
1. 成績を入力するシーズンを選択
2. チームごとに展開された選手一覧で成績を入力
3. 「一括保存」ボタンで全選手の成績を保存
4. データ確認セクションで整合性をチェック

**注意事項**
- 既存データがある場合は自動的に表示されます
- 整合性チェックは警告のみで、保存は可能です
- チームスコアチェックを行うには、先に「データ管理」ページでチームスコアを登録してください
- 保存前に確認画面でデータをチェックできます

#### チーム管理（🏢）

チームマスター情報を管理します。

| タブ | 機能 |
|-----|------|
| 📋 チーム一覧 | 登録済みチームの一覧表示、統計情報 |
| ➕ 新規登録 | 新規チームの登録（略称、カラー、設立年） |
| ✏️ 編集・削除 | チーム情報の編集、削除（関連データ件数表示） |

**機能**
- チーム略称、カラー、設立年の管理
- カスケード削除（関連データも削除）
- カラーピッカーでチームカラーを設定

#### 半荘記録入力（🎮）

半荘ごとの詳細な対局結果を記録します。

**入力項目**
- シーズン、対局日、卓区分、対局番号
- 開始時間、終了時間（任意）
- 4名分の対局結果（選手名、獲得ポイント、順位）
- 席は東・南・西・北の順で固定表示

**機能**
- タブで「新規入力」と「データ編集」を分離
- データ整合性チェック
  - ポイント合計が0であることを確認
  - 順位が1〜4で重複なし
  - 選手の重複なし
- 登録済みデータの一覧表示（最新10件）
- 既存データの編集・更新
- 対局単位でのデータ削除

**使い方**
1. 「新規入力」タブで対局情報を入力
   - シーズン、日付、卓区分、対局番号
   - 開始時間、終了時間（任意）
2. 東・南・西・北の順に選手名、獲得ポイント、順位を入力
3. データチェックを確認して保存
4. 「データ編集」タブで既存データの修正・削除が可能

**注意事項**
- 同じ対局（シーズン、日付、対局番号）のデータは上書きされます
- シーズンに所属している選手のみ選択可能
- 選手名の横にチーム名が表示されます

## 📈 半荘記録の活用

半荘ごとの詳細な対局結果を記録することで、より深い分析が可能になります。

### 詳細分析の例

**選手ごとの席別成績**
```sql
SELECT 
    seat_name,
    COUNT(*) as games,
    AVG(points) as avg_points,
    AVG(rank) as avg_rank,
    SUM(CASE WHEN rank = 1 THEN 1 ELSE 0 END) as first_count
FROM game_results
WHERE player_id = ? AND season = ?
GROUP BY seat_name;
```
→ 各席（東・南・西・北）での成績を分析し、得意な席を把握

**対戦相手との勝率**
```sql
SELECT 
    p2.player_name as opponent,
    COUNT(*) as games,
    AVG(CASE WHEN gr1.rank < gr2.rank THEN 1 ELSE 0 END) as win_rate
FROM game_results gr1
JOIN game_results gr2 ON gr1.game_date = gr2.game_date 
    AND gr1.game_number = gr2.game_number
JOIN players p2 ON gr2.player_id = p2.player_id
WHERE gr1.player_id = ? AND gr2.player_id != ?
GROUP BY p2.player_name;
```
→ 特定の選手との対戦成績を分析

**日付ごとの成績推移**
```sql
SELECT 
    game_date,
    COUNT(*) as games,
    AVG(points) as avg_points,
    AVG(rank) as avg_rank
FROM game_results
WHERE player_id = ? AND season = ?
GROUP BY game_date
ORDER BY game_date;
```
→ シーズン中の調子の波を可視化

**卓区分別の成績**
```sql
SELECT 
    table_type,
    COUNT(*) as games,
    AVG(points) as avg_points,
    AVG(rank) as avg_rank
FROM game_results
WHERE player_id = ? AND season = ?
GROUP BY table_type;
```
→ レギュラー、セミファイナル、ファイナルでの成績を比較

### 活用シーン

**選手の強み・弱みの分析**
- 席別成績から得意な席を特定
- 時期別成績から調子の波を把握
- 重要な対局での成績を分析

**チーム戦略の立案**
- 選手配置の最適化
- 対戦相手との相性分析
- セミファイナル・ファイナル対策

**ファンの楽しみ方**
- 推し選手の詳細な成績追跡
- 選手同士の対戦履歴確認
- 印象的な対局の記録

### 将来の機能拡張

半荘記録を基盤として、以下の機能を実装予定：
- 📊 移動平均の表示
- 🔄 対戦相手との勝率分析
- 🏆 連続トップ・連続ラスの記録
- 🔥 席×対戦相手のヒートマップ

## デプロイ

### Streamlit Community Cloud

1. GitHubにリポジトリをプッシュ
2. [share.streamlit.io](https://share.streamlit.io) にアクセス
3. 「New app」からリポジトリを選択
4. メインファイルに `app.py` を指定
5. 「Deploy」をクリック

## 今後の拡張予定

### 実装済み ✅

**基本機能**
- [x] 基本的なチーム成績表示（年度別・累積ランキング）
- [x] データ管理機能（チーム・シーズンポイント、ペナルティ入力）
- [x] 選手管理機能（登録・編集・削除、生年月日・所属団体管理）
- [x] チーム管理機能（チームマスター情報の管理）
- [x] シーズン更新処理（チーム名変更・選手移籍の一括処理）
- [x] 選手成績入力（一覧表示・一括入力、ペナルティ入力）
- [x] データ整合性チェック（チームスコア、選手スコア）
- [x] 選手別成績ページ（年度別ランキング・累積ランキング）
- [x] 半荘記録入力（対局結果の詳細記録、開始・終了時間、データ編集・削除）

**分析機能**
- [x] 半荘別成績分析
  - [x] チーム分析（席順別・試合番号別・直対ランキング）
  - [x] 選手分析（月別・席順別・試合番号別ランキング）
- [x] 統計分析（選手の席別パフォーマンス）
- [x] 対局記録（試合時間の記録と分析）
- [x] 月別ランキング推移（年度別・累積）
- [x] 連続記録分析（連勝・連敗・連続連対・連続逆連対）

**技術的改善**
- [x] Streamlit 1.44.0+ 非推奨警告の修正（use_container_width → width）
- [x] Pandas 2.1.0+ 非推奨警告の修正（applymap → map）

### 今後の実装予定 🚀

**選手詳細機能**
- [ ] 選手個別詳細ページ（プロフィール・シーズン別成績推移）
- [ ] 選手間の成績比較機能

**半荘記録の活用**
- [ ] 移動平均の表示
- [ ] 対戦相手との勝率分析
- [ ] 席×対戦相手のヒートマップ

**連続記録の拡張**
- [ ] 追加の連続記録
  - [ ] 連続トップ取得（1位または2位）
  - [ ] 連続ラス回避（4位以外）
  - [ ] 連続プラス/マイナス収支
- [ ] 対戦相手別の連続記録
- [ ] 席別の連続記録
- [ ] 連続記録の推移グラフ（時系列）
- [ ] 連続期間中の詳細統計

**詳細統計**
- [ ] 高度な統計指標
  - [ ] 和了率・放銃率・副露率
  - [ ] 平均着順・トップ率・ラス回避率
  - [ ] 平均持ち点・リーチ率

**データ管理**
- [ ] データのインポート/エクスポート機能
  - [ ] CSV形式でのエクスポート
  - [ ] バックアップ/リストア機能

**UI/UX改善**
- [ ] 検索・フィルター機能の強化
  - [ ] 複合条件検索
  - [ ] 期間指定フィルター
- [ ] データ可視化の強化
  - [ ] レーダーチャート（選手の強み・弱み）
  - [ ] ヒートマップ（対戦成績）
  - [ ] インタラクティブなグラフ

**パフォーマンス**
- [ ] 大量データ対応
- [ ] キャッシング機能
- [ ] ページネーション

## 技術スタック

- **フロントエンド**: Streamlit
- **データベース**: SQLite
- **可視化**: Plotly
- **データ処理**: Pandas

## ライセンス

MIT License
